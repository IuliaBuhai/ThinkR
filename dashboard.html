<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Thinkr</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #stats { display: flex; gap: 2rem; margin-bottom: 2rem; }
        .stat { background: #f0f0f0; padding: 1rem 2rem; border-radius: 8px; flex: 1; text-align: center; }
        canvas { max-width: 100%; height: 300px; }
    </style>
</head>
<body>

<h1>Dashboard</h1>

<div id="stats">
    <div class="stat">
        <h2 id="totalHours">0</h2>
        <p>Ore totale studiate</p>
    </div>
    <div class="stat">
        <h2 id="subjectsCount">0</h2>
        <p>Materii studiate</p>
    </div>
    <div class="stat">
        <h2 id="completedPlans">0</h2>
        <p>Planuri completate</p>
    </div>
</div>

<section>
    <h3>Timp studiat per materie</h3>
    <canvas id="timePerSubjectChart"></canvas>
</section>

<section>
    <h3>Progres săptămânal</h3>
    <canvas id="weeklyGoalChart"></canvas>
</section>

<script type="module">
import { 
    getFirestore, collection, query, where, getDocs 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// Firebase Config (use your config here)
const firebaseConfig = {
    apiKey: "AIzaSyDXwRE-7Cxr6YKE6MPKB7m9aC4xbirkRVY",
    authDomain: "thinkr-298dd.firebaseapp.com",
    projectId: "thinkr-298dd",
    storageBucket: "thinkr-298dd.appspot.com",
    messagingSenderId: "1087091426997",
    appId: "1:1087091426997:web:4e080caec0181377aa60fc",
    measurementId: "G-N20TE0F9VT"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const totalHoursEl = document.getElementById('totalHours');
const subjectsCountEl = document.getElementById('subjectsCount');
const completedPlansEl = document.getElementById('completedPlans');

let timePerSubjectChart;
let weeklyGoalChart;

onAuthStateChanged(auth, user => {
    if (!user) {
        window.location.href = "auth.html";
        return;
    }
    loadUserStats(user.uid);
    renderCharts(user.uid);
});

// Load and display stats (total hours, subjects, completed plans)
async function loadUserStats(userId) {
    try {
        const sessionsQuery = query(collection(db, "studySessions"), where("userId", "==", userId));
        const sessionsSnapshot = await getDocs(sessionsQuery);

        let totalSeconds = 0;
        let subjectsSet = new Set();

        sessionsSnapshot.forEach(doc => {
            const data = doc.data();
            totalSeconds += data.durationInSeconds;
            subjectsSet.add(data.subject);
        });

        totalHoursEl.textContent = (totalSeconds / 3600).toFixed(1);
        subjectsCountEl.textContent = subjectsSet.size;

        const plansQuery = query(collection(db, "studyPlans"), where("userId", "==", userId));
        const plansSnapshot = await getDocs(plansQuery);
        completedPlansEl.textContent = plansSnapshot.size;

    } catch (err) {
        console.error("Error loading user stats:", err);
    }
}

// Render charts based on study session data
async function renderCharts(userId) {
    try {
        const sessionsQuery = query(collection(db, "studySessions"), where("userId", "==", userId));
        const sessionsSnapshot = await getDocs(sessionsQuery);

        const subjectDurations = {};
        const weeklyDurations = {};

        sessionsSnapshot.forEach(doc => {
            const data = doc.data();
            const subject = data.subject || "Nespecificat";
            const duration = data.durationInSeconds || 0;

            // Accumulate time per subject
            subjectDurations[subject] = (subjectDurations[subject] || 0) + duration;

            // Accumulate time per day (for last 7 days)
            const startDate = data.startTime.toDate();
            const dayKey = startDate.toISOString().substring(0, 10); // YYYY-MM-DD
            weeklyDurations[dayKey] = (weeklyDurations[dayKey] || 0) + duration;
        });

        drawTimePerSubjectChart(subjectDurations);
        drawWeeklyGoalChart(weeklyDurations);

    } catch (err) {
        console.error("Error rendering charts:", err);
    }
}

function drawTimePerSubjectChart(data) {
    const ctx = document.getElementById('timePerSubjectChart').getContext('2d');

    const labels = Object.keys(data);
    const durations = labels.map(subject => (data[subject] / 3600).toFixed(2)); // hours

    if (timePerSubjectChart) timePerSubjectChart.destroy();

    timePerSubjectChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Ore studiate',
                data: durations,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Ore' } }
            }
        }
    });
}

function drawWeeklyGoalChart(data) {
    const ctx = document.getElementById('weeklyGoalChart').getContext('2d');

    // Prepare last 7 days labels
    const last7Days = [];
    for(let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        last7Days.push(d.toISOString().substring(0, 10));
    }

    // Map durations to last 7 days (hours)
    const durations = last7Days.map(day => ((data[day] || 0) / 3600).toFixed(2));

    if (weeklyGoalChart) weeklyGoalChart.destroy();

    weeklyGoalChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days,
            datasets: [{
                label: 'Ore studiate pe zi',
                data: durations,
                fill: true,
                backgroundColor: 'rgba(255, 206, 86, 0.3)',
                borderColor: 'rgba(255, 206, 86, 1)',
                tension: 0.3,
                pointRadius: 5,
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Ore' } }
            }
        }
    });
}
</script>

</body>
</html>
